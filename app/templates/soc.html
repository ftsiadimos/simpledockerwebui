{% extends 'base.html' %}

{% block content %}
<style>
  .terminal-container {
    background-color: #1e1e1e;
    border-radius: 8px;
    overflow: hidden;
  }
  .terminal-header {
    background-color: #2d2d2d;
    padding: 0.5rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #3d3d3d;
  }
  .terminal-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .terminal-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
  }
  .terminal-dot.red { background-color: #ff5f56; }
  .terminal-dot.yellow { background-color: #ffbd2e; }
  .terminal-dot.green { background-color: #27ca40; }
  .terminal-body {
    padding: 1rem;
    max-height: 70vh;
    min-height: 400px;
    overflow-y: auto;
    overflow-x: auto;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 0.875rem;
    line-height: 1.6;
  }
  .terminal-body::-webkit-scrollbar {
    width: 8px;
  }
  .terminal-body::-webkit-scrollbar-track {
    background: #2d2d2d;
  }
  .terminal-body::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 4px;
  }
  #log {
    color: #00ff00;
  }
  .terminal-input-line {
    display: flex;
    align-items: center;
    margin-top: 0.5rem;
  }
  .terminal-prompt {
    color: #00ff00;
    margin-right: 0.5rem;
    white-space: nowrap;
  }
  .terminal-input {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: #00ff00;
    font-family: inherit;
    font-size: inherit;
    caret-color: #00ff00;
  }
  .terminal-input::placeholder {
    color: #666;
  }
  .output-line { color: #00ff00; }
  .input-line { color: #ff6b6b; }
  .error-line { color: #ff5f56; }
  .terminal-hint {
    color: #666;
    font-size: 0.75rem;
    margin-top: 0.5rem;
  }
</style>

<div class="terminal-container shadow">
  <div class="terminal-header">
    <div class="terminal-title">
      <span class="terminal-dot red"></span>
      <span class="terminal-dot yellow"></span>
      <span class="terminal-dot green"></span>
      <span class="text-light ms-2">Terminal â€” {{ id[:12] }}</span>
    </div>
    <button type="button" class="btn btn-outline-light btn-sm" onclick="window.history.back();" title="Close terminal">
      <i class="fa fa-times" aria-hidden="true"></i> Close
    </button>
  </div>
  <div id="output" class="terminal-body">
    <div id="log"></div>
    <form id="terminalForm" class="terminal-input-line">
      <span class="terminal-prompt">$</span>
      <input type="text" 
             id="terminalInput" 
             class="terminal-input" 
             autocomplete="off" 
             autofocus
             placeholder="Type a command...">
    </form>
    <div class="terminal-hint">
      Built-in commands: <code>cd</code>, <code>pwd</code>, <code>clear</code>
    </div>
  </div>
</div>

<script>
  const log = document.getElementById('log');
  const output = document.getElementById('output');
  const form = document.getElementById('terminalForm');
  const input = document.getElementById('terminalInput');

  // WebSocket connection
  const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
  const socket = new WebSocket(`${wsProtocol}//${location.host}/echo?id={{ id }}`);

  // Log message to terminal
  function appendLog(text, className) {
    const formatted = text.replace(/\n/g, '<br>');
    const line = document.createElement('div');
    line.className = className;
    line.innerHTML = formatted;
    log.appendChild(line);
    output.scrollTop = output.scrollHeight;
  }

  // Handle incoming messages
  socket.addEventListener('message', (event) => {
    if (event.data === '__CLEAR__') {
      log.innerHTML = '';
    } else {
      appendLog(event.data, 'output-line');
    }
  });

  // Handle connection events
  socket.addEventListener('open', () => {
    appendLog('Connected to container terminal.', 'output-line');
  });

  socket.addEventListener('close', () => {
    appendLog('Connection closed.', 'error-line');
  });

  socket.addEventListener('error', () => {
    appendLog('Connection error.', 'error-line');
  });

  // Handle form submission
  form.addEventListener('submit', (event) => {
    event.preventDefault();
    const command = input.value.trim();
    if (command) {
      appendLog(`$ ${command}`, 'input-line');
      socket.send(command);
      input.value = '';
    }
  });

  // Keep input focused
  output.addEventListener('click', () => {
    input.focus();
  });

  // Scroll to bottom on load
  window.addEventListener('load', () => {
    output.scrollTop = output.scrollHeight;
    input.focus();
  });
</script>
{% endblock %}